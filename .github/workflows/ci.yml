name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: '1.25.x'
          cache: true

      - name: Download modules
        run: go mod download

      - name: Format check
        run: |
          files="$(find . -name '*.go' -type f)"
          [ -z "$files" ] || test -z "$(gofmt -l $files)"

      - name: Vet
        run: go vet ./...

      - name: Unit tests with coverage
        run: go test ./... -coverprofile=coverage.out -covermode=atomic

      - name: Coverage gate
        env:
          COVERAGE_THRESHOLD: '60'
        run: ./ci/coverage_gate.sh coverage.out

      - name: Install roady
        run: go install github.com/felixgeelhaar/roady/cmd/roady@latest

      - name: Roady helper smoke tests
        run: bash ci/test_roady_helpers.sh

      - name: Roady preflight
        run: bash ci/roady_preflight.sh

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Dependency vulnerability scan
        run: govulncheck ./...

      - name: Nox security scan
        run: go run github.com/nox-hq/nox/cli@latest scan .
